#!/bin/bash

# æœ€é€Ÿã§ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ã‚¢ãƒ—ãƒªåã ã‘å…¥åŠ›ã—ã¦ã€ã‚ã¨ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§å®Ÿè¡Œ

set -e

# ã‚«ãƒ©ãƒ¼å®šç¾©
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# å…±é€šé–¢æ•°ã‚’èª­ã¿è¾¼ã‚€
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common-functions.sh"

# å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
OUTPUT_DIR="$(dirname "$0")/../results"
mkdir -p "$OUTPUT_DIR"
OUTPUT_FILE="$OUTPUT_DIR/00_user_input.md"

# æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç¢ºèªã¨ã‚¯ãƒªã‚¢
if [ -f "$PROJECT_ROOT/.current_project" ] || [ -f "$PROJECT_ROOT/ClaudeFlow/implementation/features.json" ]; then
    echo -e "${YELLOW}ðŸ§¹ å‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™...${NC}"
    clear_project_state "quick_project_$(date +%H%M%S)"
    echo ""
fi

# ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
clear
echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}    AIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º - ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ    ${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""
echo "æœ€å°é™ã®å…¥åŠ›ã§ã€AIãŒæœ€é©ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚"
echo ""

# ã‚¢ãƒ—ãƒªåã¾ãŸã¯æ¦‚è¦ã®å…¥åŠ›
echo -e "${GREEN}ä½œã‚ŠãŸã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€è¨€ã§æ•™ãˆã¦ãã ã•ã„ã€‚${NC}"
echo -e "${YELLOW}ä¾‹: ã‚¿ã‚¹ã‚¯ç®¡ç†ã€åœ¨åº«ç®¡ç†ã€äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã€æ—¥å ±ã‚¢ãƒ—ãƒª ãªã©${NC}"
echo -e "${YELLOW}(Enterã‚­ãƒ¼ã®ã¿ã§ã€ŒAIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ã«ãªã‚Šã¾ã™)${NC}"
echo -n "> "
read app_input

# å…¥åŠ›å†…å®¹ã®åˆ¤å®šã¨è¨­å®š
if [ -z "$app_input" ]; then
    app_name="AIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"
    app_description="æ¥­å‹™åŠ¹çŽ‡åŒ–ã‚’ç›®çš„ã¨ã—ãŸæ±Žç”¨çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"
    echo -e "${BLUE}â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®AIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™${NC}"
else
    # å…¥åŠ›ãŒçŸ­ã„å ´åˆã¯ã‚¢ãƒ—ãƒªåã¨ã—ã¦æ‰±ã„ã€é•·ã„å ´åˆã¯èª¬æ˜Žã¨ã—ã¦æ‰±ã†
    if [ ${#app_input} -le 20 ]; then
        app_name="${app_input}ã‚¢ãƒ—ãƒª"
        app_description="${app_input}ã‚’åŠ¹çŽ‡çš„ã«è¡Œã†ãŸã‚ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"
    else
        app_name="AIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"
        app_description="$app_input"
    fi
    echo -e "${BLUE}â†’ ã€Œ${app_name}ã€ã‚’ä½œæˆã—ã¾ã™${NC}"
fi

echo ""

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
cat > "$OUTPUT_FILE" << EOF
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¼ç”»æ›¸ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼‰

## åŸºæœ¬æƒ…å ±
- **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å**: $app_name
- **æ¦‚è¦**: $app_description

## ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
- **æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼**: ä¸€èˆ¬çš„ãªãƒ“ã‚¸ãƒã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **æƒ³å®šåˆ©ç”¨è€…æ•°**: 100äººç¨‹åº¦

## æ©Ÿèƒ½è¦ä»¶
### å¿…é ˆæ©Ÿèƒ½
ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã€ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã€æ¤œç´¢æ©Ÿèƒ½

### è¿½åŠ æ©Ÿèƒ½
ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼, æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½, ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ

## ä½¿ç”¨ç’°å¢ƒ
- **ãƒ‡ãƒã‚¤ã‚¹**: ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹
- **ä½¿ç”¨é »åº¦**: æ¯Žæ—¥

## ãƒ‡ã‚¶ã‚¤ãƒ³è¦ä»¶
- **å„ªå…ˆåº¦**: ã‚·ãƒ³ãƒ—ãƒ«ã§ä½¿ã„ã‚„ã™ã‘ã‚Œã°è‰¯ã„
- **å‚è€ƒ**: ãªã—

## éžæ©Ÿèƒ½è¦ä»¶
- **ãƒ‡ãƒ¼ã‚¿æ©Ÿå¯†æ€§**: ç¤¾å†…æƒ…å ±ï¼ˆä¸­ç¨‹åº¦ï¼‰
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: é€šå¸¸ã®é€Ÿåº¦ã§å•é¡Œãªã„

---
*ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
EOF

# é–‹ç™ºè¨­å®šã‚’é¸æŠž
echo -e "${CYAN}é–‹ç™ºè¨­å®šã‚’é¸æŠžã—ã¦ãã ã•ã„ï¼š${NC}"
echo "1) é«˜é€Ÿãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— - æœ€é€Ÿã§ã‚³ã‚¢æ©Ÿèƒ½ã®ã¿å®Ÿè£…ï¼ˆæŽ¨å¥¨ï¼‰"
echo "2) æ¨™æº–é–‹ç™º - ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå…¨æ©Ÿèƒ½å®Ÿè£…"
echo "3) æœ¬æ ¼é–‹ç™º - å®Œå…¨å“è³ªã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…"
echo "4) ã‚«ã‚¹ã‚¿ãƒ è¨­å®š - è©³ç´°ã«è¨­å®š"
echo -n "é¸æŠž (1-4) [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1]: "
read -r dev_mode

case "${dev_mode:-1}" in
    1) apply_preset "rapid" ;;
    2) apply_preset "standard" ;;
    3) apply_preset "production" ;;
    4) configure_claudeflow_custom ;;
    *) apply_preset "rapid" ;;
esac

echo ""
show_current_config

echo -e "${GREEN}âœ… è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼${NC}"
echo ""
echo "ç”Ÿæˆã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼š"
echo "- ã‚¢ãƒ—ãƒªå: ${app_name}"
echo "- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ä»˜ã"
echo "- ãƒ‡ãƒ¼ã‚¿ã®CRUDæ“ä½œ"
echo "- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆPC/ã‚¹ãƒžãƒ›å¯¾å¿œï¼‰"
echo "- ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼æ©Ÿèƒ½"
echo ""
echo -e "${YELLOW}é–‹ç™ºã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ (y/n)${NC}"
read -n 1 confirm
echo ""

if [[ $confirm =~ ^[Yy]$ ]]; then
    # ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ã‹ã‚‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œ
    echo -e "${BLUE}ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æœ€é©åŒ–ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆä¸­...${NC}"
    "$(dirname "$0")/generate-tasks.sh" "$OUTPUT_FILE"
    
    echo ""
    echo -e "${BLUE}é–‹ç™ºã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...${NC}"
    "$(dirname "$0")/run-pipeline.sh" "$OUTPUT_FILE"
else
    echo "é–‹ç™ºã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚"
    echo "å¾Œã§é–‹ç™ºã‚’é–‹å§‹ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š"
    echo "  ./scripts/run-pipeline.sh $OUTPUT_FILE"
fi